{
  "name": "Stage 1 - Screen 100 to 50",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-1",
      "name": "Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 0]
    },
    {
      "parameters": {
        "jsCode": "// 100 Value Stock Candidates - Top US large caps (reduced for API rate limits)\nconst stocks = [\n  // Technology (15)\n  'AAPL', 'MSFT', 'GOOGL', 'META', 'AVGO', 'ORCL', 'CRM', 'CSCO', 'ACN', 'IBM',\n  'INTC', 'QCOM', 'TXN', 'INTU', 'AMAT',\n  \n  // Healthcare (15)\n  'UNH', 'JNJ', 'LLY', 'PFE', 'ABBV', 'MRK', 'TMO', 'ABT', 'DHR', 'BMY',\n  'AMGN', 'GILD', 'CVS', 'ELV', 'CI',\n  \n  // Financials (15)\n  'JPM', 'V', 'MA', 'BAC', 'WFC', 'GS', 'MS', 'BLK', 'SPGI', 'AXP',\n  'C', 'SCHW', 'CB', 'MMC', 'PGR',\n  \n  // Consumer Discretionary (12)\n  'AMZN', 'HD', 'MCD', 'NKE', 'LOW', 'SBUX', 'TJX', 'BKNG',\n  'ORLY', 'MAR', 'YUM', 'GM',\n  \n  // Consumer Staples (12)\n  'PG', 'KO', 'PEP', 'COST', 'WMT', 'PM', 'MO', 'MDLZ', 'CL', 'KMB',\n  'GIS', 'HSY',\n  \n  // Energy (10)\n  'XOM', 'CVX', 'COP', 'EOG', 'SLB', 'MPC', 'PSX', 'VLO', 'OXY', 'WMB',\n  \n  // Industrials (12)\n  'CAT', 'GE', 'HON', 'UNP', 'UPS', 'RTX', 'DE', 'LMT', 'MMM', 'ETN',\n  'ITW', 'EMR',\n  \n  // Utilities (5)\n  'NEE', 'DUK', 'SO', 'D', 'AEP',\n  \n  // Materials (4)\n  'LIN', 'APD', 'SHW', 'ECL'\n];\n\nconsole.log(`Total input stocks: ${stocks.length}`);\nreturn stocks.map(s => ({ json: { symbol: s } }));"
      },
      "id": "code-list",
      "name": "100 Stocks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "url": "=https://financialmodelingprep.com/stable/profile?symbol={{ $json.symbol }}&apikey=4x1WuP5kwdOeGA0lejzbQ3gAq2Ytcmpt",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 5,
              "batchInterval": 3000
            }
          },
          "timeout": 15000
        }
      },
      "id": "http-1",
      "name": "Get Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 0]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  const p = Array.isArray(data) ? data[0] : data;\n  \n  if (!p || !p.symbol || p.error) continue;\n  \n  const marketCap = p.marketCap || 0;\n  const price = p.price || 0;\n  const pe = p.pe || 0;\n  const beta = p.beta || 1;\n  const lastDiv = p.lastDividend || 0;\n  const divYield = price > 0 ? lastDiv / price : 0;\n  \n  // === VALUE SCREENING CRITERIA ===\n  // 1. Market cap > $10B (large cap focus)\n  if (marketCap < 10e9) continue;\n  \n  // 2. P/E between 5-30 (reasonable valuation)\n  if (pe <= 5 || pe > 30) continue;\n  \n  // 3. Not too volatile (beta < 1.5)\n  if (beta > 1.5) continue;\n  \n  // 4. Price > $10 (no penny stocks)\n  if (price < 10) continue;\n  \n  // Format market cap\n  let mcDisplay = '$0';\n  if (marketCap >= 1e12) mcDisplay = '$' + (marketCap/1e12).toFixed(1) + 'T';\n  else if (marketCap >= 1e9) mcDisplay = '$' + (marketCap/1e9).toFixed(0) + 'B';\n  \n  results.push({\n    json: {\n      symbol: p.symbol,\n      company_name: p.companyName || '',\n      sector: p.sector || '',\n      industry: p.industry || '',\n      exchange: p.exchange || '',\n      price: Math.round(price * 100) / 100,\n      market_cap: marketCap,\n      market_cap_display: mcDisplay,\n      pe_ratio: Math.round(pe * 100) / 100,\n      beta: Math.round(beta * 100) / 100,\n      dividend_yield: Math.round(divYield * 10000) / 10000,\n      dividend_yield_pct: (divYield * 100).toFixed(2) + '%',\n      volume: p.volume || 0,\n      avg_volume: p.averageVolume || 0,\n      year_high: p.range ? parseFloat(p.range.split('-')[1]) : 0,\n      year_low: p.range ? parseFloat(p.range.split('-')[0]) : 0,\n      change_pct: Math.round((p.changePercentage || 0) * 100) / 100,\n      is_profitable: pe > 0,\n      is_dividend_paying: lastDiv > 0,\n      is_penny_stock: false,\n      last_updated: new Date().toISOString().split('T')[0]\n    }\n  });\n}\n\n// Sort by market cap descending and limit to 50\nresults.sort((a, b) => b.json.market_cap - a.json.market_cap);\nconst top50 = results.slice(0, 50);\n\nconsole.log(`Filtered from ${items.length} to ${top50.length} value stocks`);\nreturn top50;"
      },
      "id": "code-filter",
      "name": "Filter to Top 50",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 0]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1jMRAtD1tUQSYYD1gLWoHNw1IoBbUP-SPpBbStj01be0"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "Stage1_Screened"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "id": "sheets-1",
      "name": "Write to Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [880, 0]
    }
  ],
  "connections": {
    "Start": {
      "main": [[{ "node": "250 Stocks", "type": "main", "index": 0 }]]
    },
    "250 Stocks": {
      "main": [[{ "node": "Get Profile", "type": "main", "index": 0 }]]
    },
    "Get Profile": {
      "main": [[{ "node": "Filter to Top 50", "type": "main", "index": 0 }]]
    },
    "Filter to Top 50": {
      "main": [[{ "node": "Write to Sheets", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
